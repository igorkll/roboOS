local b,c=component,computer;local d,e=b.proxy(b.list"gpu"()or""),b.proxy(b.list"eeprom"())if d then if d.bind(b.list"screen"()or"",true)then d.setResolution(50,16)else d=a end end;local function f(g)return split(e.getData(),"\n")[g]or""end;_G.getDataPart=f;local function h(g,i)if f(g)==i then return end;if i:find"\n"then error"\\n char"end;local j=split(e.getData(),"\n")for k=g,1,-1 do if not j[k]then j[k]=""end end;j[g]=i;e.setData(table.concat(j,"\n"))end;_G.getDataPart=f;local function split(l,m)local j,n,k={},1,1;while 1 do if k>#l then break end;local o=l:sub(k,#m+k-1)if not j[n]then j[n]=""end;if o==m then n=n+1;k=k+#m else j[n]=j[n]..l:sub(k,k)k=k+1 end end;if l:sub(#l-(#m-1),#l)==m then table.insert(j,"")end;return j end;_G.split=split;local function p(l,q)local r={}while#l>0 do table.insert(r,l:sub(1,q))l=l:sub(#r[#r]+1)end;return r end;_G.toParts=p;local function s(t,u)local u,v=assert(t.open(u,"rb")),""while 1 do local w=t.read(u,math.huge)if not w then break end;v=v..w end;t.close(u)return v end;_G.getFile=s;local function x(t,u,w)local u=assert(t.open(u,"wb"))t.write(u,w)t.close(u)end;_G.saveFile=x;local function y(t,u)function c.getBootAddress()return t.address end;function c.getBootGpu()return d and d.address end;function c.getBootScreen()return d and d.getScreen()end;function c.getBootFile()return u end;function c.setBootAddress()end;function c.setBootScreen()end;function c.setBootFile()end;assert(load(s(t,u),"=init"))()c.shutdown()end;local function z(A)local B=split(A,"/")if B[#B]==""then B[#B]=a end;return table.concat({table.unpack(B,1,#B-1)},"/")end;_G.fs_path=z;local function C(D)local E,w,F,G=b.proxy(b.list"internet"()).request(D),""if E then while 1 do F,G=E.read(math.huge)if F then w=w..F else E.close()if G then return a,G else return w end end end else return a,"Unvalid Address"end end;_G.getInternetFile=C;if d then gui={}local H,I=d.getResolution()local J,K,r,L="","",{},math.floor(H/3*2)function gui.invert()d.setBackground(d.setForeground(d.getBackground()))end;function gui.read(l)local v=""local function M()local l=l..": "..v.."_"while#l>H do l=l:sub(2,#l)end;d.set(1,I,l.." ")end;M()local function N()d.fill(1,I,H,1," ")end;while 1 do local O={c.pullSignal()}if O[1]=="key_down"then if O[4]==28 then N()return v elseif O[3]>=32 and O[3]<=126 then v=v..string.char(O[3])M()elseif O[4]==14 then if#v>0 then v=v:sub(1,#v-1)M()end elseif O[4]==46 then N()break end elseif O[1]=="clipboard"then v=v..O[3]M()if v:byte(#v)==13 then N()return v end end end end;function gui.draw(P,Q)d.fill(1,1,H,I," ")d.set(1,1,J)d.fill(1,2,H,1,"─")d.fill(1,I-1,H,1,"─")d.fill(L,3,1,I-4,"│")d.fill(L+1,I/2,H-L,1,"─")local function R(S,T)local U,V=split(S or"not found","\n"),{}for k,W in ipairs(U)do local X=p(W,H-L)for k,W in ipairs(X)do table.insert(V,W)end end;for k,w in ipairs(V)do d.set(L+1,k+T-1,w)end end;d.set(L+1,3,"menu doc:")R(K[0],4)d.set(L+1,I/2+1,"menu point doc:")R(K[P],I/2+2)for k,w in ipairs(r)do local T=k+2;T=T-Q;if T>=3 and T<=I-2 then if k==P then gui.invert()end;d.set(1,T,w)if k==P then gui.invert()end end end end;function gui.menu(P,Q)gui.draw(P,Q)while 1 do local O={c.pullSignal()}if O[1]=="key_down"then if O[4]==28 then return P,Q elseif O[4]==200 then if P>1 then P=P-1;if P+2-Q<3 then Q=Q-1 end;gui.draw(P,Q)end elseif O[4]==208 then if P<#r then P=P+1;if P+2-Q>I-2 then Q=Q+1 end;gui.draw(P,Q)end end end end end;function gui.setData(Y,Z,_)J,K=Y,type(Z)=="string"and{[0]=Z}or Z;r={}for k,W in ipairs(_)do local l=W:sub(1,L-1)while#l<L-1 do l=l.." "end;table.insert(r,l)end end;function gui.setText(l,a0,T)d.set((a0 or 0)+math.floor(H/2-(unicode.len(l)-1)/2+0.5),T or math.floor(I/2+0.5),l)end;function gui.warn(l)d.fill(8,3,H-15,I-4,"▒")gui.setText("▒▒▒▒▒▒█▒▒▒▒▒▒",a,4)gui.setText("▒▒▒▒▒███▒▒▒▒▒",a,5)gui.setText("▒▒▒▒██ ██▒▒▒▒",a,6)gui.setText("▒▒▒███ ███▒▒▒",a,7)gui.setText("▒▒█████████▒▒",a,8)gui.setText("▒█████ █████▒",a,9)gui.setText("█████████████",a,10)gui.setText(l,a,12)gui.setText("Press Enter To Continue",a,13)c.beep(100,0.2)while 1 do local O={c.pullSignal()}if O[1]=="key_down"and O[4]==28 then break end end end;function gui.status(l)d.fill(8,3,H-15,I-4,"▒")gui.setText(l,a,I/2)c.beep(1000,0.1)end;function gui.yesno(l)gui.invert()d.fill(H/2-10,I/2-1,20,5,"▒")gui.setText(l,a,I/2)c.beep(500,0.01)c.beep(2000,0.01)local a1=a;while 1 do if a1 then gui.invert()end;gui.setText("yes",-5,I/2+2)if a1 then gui.invert()end;if not a1 then gui.invert()end;gui.setText("no",5,I/2+2)if not a1 then gui.invert()end;local O={c.pullSignal()}if O[1]=="key_down"then if O[4]==203 then a1=1 elseif O[4]==205 then a1=a elseif O[4]==28 then gui.invert()return a1 end end end end end;local a2;if gui then local a3=f(1)=="1"if a3 then gui.invert()end;function a2(a4)if a4~=a3 then gui.invert()h(1,a4 and"1"or"")a3=a4 end end end;local function a5()local P,Q,r,S=1,0,{"white","black","exit"},{[0]="theme selector","white theme","black theme"}while 1 do gui.setData("theme selector",S,r)P,Q=gui.menu(P,Q)if P==1 then a2(true)elseif P==2 then a2(false)elseif P==3 then break end end end;local function a6()local P,Q=1,0;while 1 do local r,a7,K={"add new user","exit"},{},{[0]="user management(useradd/userremove/userlist)","press enter to add new user"}for a8,a9 in ipairs{c.users()}do table.insert(r,1,a9)table.insert(a7,1,function()if gui.yesno"remove user?"then for k,W in ipairs(r)do if W==a9 then table.remove(r,k)table.remove(a7,k)c.removeUser(a9)break end end end end)table.insert(K,1,"press enter to remove this user")end;gui.setData("usermenager",K,r)P,Q=gui.menu(P,Q)if P==#r then break elseif P==#r-1 then local a9=gui.read"nikname"if a9 then local aa,ab=c.addUser(a9)if not aa then gui.warn(ab)end end else a7[P]()end end end;local function ac()local P,Q,r,S=1,0,{"priority external","priority internal","only external","only internal","disable","exit"},{}local function ad()if f(2)==""then S[0]="autoruns settings".."currect mode:\npriority external"elseif f(2)=="i"then S[0]="autoruns settings".."currect mode:\npriority internal"elseif f(2)=="b"then S[0]="autoruns settings".."currect mode:\nonly external"elseif f(2)=="a"then S[0]="autoruns settings".."currect mode:\nonly internal"elseif f(2)=="d"then S[0]="autoruns settings".."currect mode:\ndisable"end end;ad()while 1 do gui.setData("autorun",S,r)P,Q=gui.menu(P,Q)if P==1 then h(2,"")elseif P==2 then h(2,"i")elseif P==3 then h(2,"b")elseif P==4 then h(2,"a")elseif P==5 then h(2,"d")elseif P==6 then break end;ad()end end;local function ae()while 1 do local P,Q,r,af,K=1,0,{"exit"},{},{[0]="boot to:\nopenOS\nplan9k\nother..."}for ag in b.list"filesystem"do local ah=b.proxy(ag)local function ai(u)table.insert(r,1,(ah.getLabel()or"noLabel")..":"..ag:sub(1,6)..":"..u)table.insert(af,1,function()y(ah,u)end)table.insert(K,1,"label: "..(ah.getLabel()or"noLabel").."\naddress: "..ag:sub(1,6).."\nfile: "..u)end;if ah.exists"/init.lua"then ai"/init.lua"end;for a8,u in ipairs(ah.list"/boot/kernel"or{})do ai("/boot/kernel/"..u)end end;while 1 do gui.setData("boot to external os",K,r)P,Q=gui.menu(P,Q)if P==#r then return else af[P]()end end end end;local function aj()local P,Q,r,S=1,0,{"autorun","usermenager","theme","exit"},{"set autorun mode and autorun programm","user management(useradd/userremove/userlist)","theme selector"}while 1 do gui.setData("settings",S,r)P,Q=gui.menu(P,Q)if P==1 then ac()elseif P==2 then a6()elseif P==3 then a5()elseif P==4 then break end end end;local function ak(t,u)local aa,w=pcall(s,t,u)if not aa or not w then local al="err to get programm"if gui then gui.warn(al)end;return a,al end;local am,ab=load(w,"=programm")if not am then if gui then gui.warn("err to load programm: "..ab)end;return a,ab end;local aa,ab=pcall(am,{file=u,fs=t})if not aa then if gui then gui.warn("err to run programm: "..(ab or"unknown"))end;return a,ab or"unknown"end;return 1 end;local function an()local ao=b.proxy(b.list"internet"()or"")if not ao then gui.warn"internet card is not found"return end;local D=gui.read("url")if D then gui.status"downloading"local w,ab=C(D)if not w then gui.warn(ab or"unknown")return end;local r,ap={},{}for ag in b.list"filesystem"do local ah=b.proxy(ag)if not ah.isReadOnly()then table.insert(ap,function()local aq=gui.read"name to save"if aq then if aq:find"%/"or aq:find"%\\"then gui.status"unsupported char /"else local A="/roboOS/programs/"..aq;if ah.exists(A)then gui.warn("this name used")return end;ah.makeDirectory(A)x(ah,A.."/main.lua",w)return 1 end end end)table.insert(r,(ah.getLabel()or"noLabel")..":"..ag:sub(1,6))end end;table.insert(r,"exit")gui.setData("select drive to save",{},r)local P,Q=1,0;while 1 do P,Q=gui.menu(P,Q)if not ap[P]then break end;if ap[P]()then return 1 end end end end;local ar,as;if f(2)~="d"then local at,au,av={},{},{}do local aw=c.getDeviceInfo()for ag in b.list"filesystem"do if ag~=c.tmpAddress()and(b.slot(ag)<0 or aw[ag].clock=="20/20/20")then table.insert(au,ag)else table.insert(at,ag)end end end;if f(2)==""then table.insert(av,au)table.insert(av,at)elseif f(2)=="i"then table.insert(av,at)table.insert(av,au)elseif f(2)=="a"then table.insert(av,at)elseif f(2)=="b"then table.insert(av,au)end;for a8,ax in ipairs(av)do for a8,ag in ipairs(ax)do local ah=b.proxy(ag)if ah.exists"/roboOS/autorun.cfg"then local w=s(ah,"/roboOS/autorun.cfg")if ah.exists(w)then ar=ah;as=w;goto ay end end end end::ay::end;if ar then if gui then gui.status"press alt to skip autorun"local az=c.uptime()repeat local O={c.pullSignal(0.1)}if O[1]=="key_down"and O[4]==56 then goto aA end until c.uptime()-az>1 end;ak(ar,as)::aA::end;if gui then while 1 do local P,Q,r,S,ap=1,0,{"refresh","shutdown","reboot","settings","boot to external os","download programm"},{[0]="navigation ↑↓\nok - enter",[5]="boot to:\nopenOS\nplan9k\nother...",[6]="download programm from internet used internet-card"},{}for ag in b.list"filesystem"do local ah,aB=b.proxy(ag),"/roboOS/programs/"for a8,u in ipairs(ah.list(aB)or{})do local aC=aB..u;if ah.isDirectory(aC)and ah.exists(aC.."main.lua")then local aD=u:sub(1,#u-1)table.insert(r,aD)local aE=#r;S[aE]="address: "..ag:sub(1,6).."\nlabel: "..(ah.getLabel()or"noLabel").."\n"if ah.exists(aC.."doc.txt")then S[aE]=S[aE]..s(ah,aC.."doc.txt")end;ap[aE]=function()local function aF(aG)local r={}local aH={}for ag in b.list"filesystem"do local ah=b.proxy(ag)if not ah.isReadOnly()then table.insert(r,(ah.getLabel()or"noLabel")..":"..ag:sub(1,6))table.insert(aH,ag)end end;table.insert(r,"exit")gui.setData("select target to "..(aG and"move "or"copy ")..aD,{},r)local P,Q=gui.menu(1,0)if not aH[P]then return 1 end;local aq=aD;if gui.yesno"use new name?"then gui.draw(P,Q)local aI=gui.read"new name"if not aI then gui.warn"using new name canceled"gui.draw(P,Q)elseif aq:find"%/"or aq:find"%\\"then gui.warn"unsupported char /"return 1 else aq=aI end end;if not gui.yesno(aG and"move?"or"copy?")then return 1 end;local aJ=b.proxy(aH[P])local function aK(A,aL)for a8,u in ipairs(ah.list(A))do local aM=A..u;local aN=aL.."/"..u;if ah.isDirectory(aM)then aK(aM,aN)else aJ.makeDirectory(z(aN))x(aJ,aN,s(ah,aM))end end end;if aJ.exists("/roboOS/programs/"..aq)then gui.warn"this name used"return 1 end;aK(aC,"/roboOS/programs/"..aq)end;local P,Q,aO=1,0;while 1 do gui.setData("programm "..aD,{[0]=S[aE]},{"open","set to autorun","move","copy","remove","rename","back"})P,Q=gui.menu(P,Q)local aP=aC;local aQ=ah.exists"/roboOS/autorun.cfg"and s(ah,"/roboOS/autorun.cfg")==aP.."main.lua"if P==1 then if not ak(ah,aC.."main.lua")then return 1 end elseif P==2 then if gui.yesno("set autorun?")then x(ah,"/roboOS/autorun.cfg",aC.."main.lua")end elseif P==3 then if not aF(1)then ah.remove(aC)if aQ then ah.remove"/roboOS/autorun.cfg"end;return 1 end elseif P==4 then if not aF()then aO=1 end elseif P==5 then if gui.yesno"remove?"then ah.remove(aC)if aQ then ah.remove"/roboOS/autorun.cfg"end;return 1 end elseif P==6 then local w=gui.read"new name"if w then if w:find"%/"or w:find"%\\"then gui.warn"unsupported char /"else aC=z(aP).."/"..w;ah.rename(aP,aC)if aQ then x(ah,"/roboOS/autorun.cfg",aC.."/main.lua")end;return 1 end end else return aO end end end end end end;while 1 do gui.setData("roboOS",S,r)P,Q=gui.menu(P,Q)if P==1 then break elseif P==2 then c.shutdown()elseif P==3 then c.shutdown(1)elseif P==4 then aj()elseif P==5 then ae()elseif P==6 then if an()then break end else if ap[P]()then break end end end end end